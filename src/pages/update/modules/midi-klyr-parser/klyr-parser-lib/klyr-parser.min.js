export class MidiKLyrParser{constructor(){this.midiData=null,this.rawMidiBuffer=null,this.songInfo={},this.lyricsData=[],this.chordsData=[],this.detectedHeader="LyrHdr1"}stringToTIS620(e){let t=[];for(let r=0;r<e.length;r++){let a=e.charCodeAt(r);a<=127?t.push(a):a>=3585&&a<=3675?t.push(a-3585+161):t.push(63)}return new Uint8Array(t)}TIS620ToString(e){let t="";for(let r=0;r<e.length;r++){let a=e[r];a<=127?t+=String.fromCharCode(a):a>=161&&a<=251?t+=String.fromCharCode(a-161+3585):t+="?"}return t}base64ToArrayBuffer(e){let t=atob(e),r=new Uint8Array(t.length);for(let a=0;a<t.length;a++)r[a]=t.charCodeAt(a);return r.buffer}arrayBufferToBase64(e){let t=new Uint8Array(e),r="";for(let a=0;a<t.length;a++)r+=String.fromCharCode(t[a]);return btoa(r)}parseMidiFile(e){let t=new DataView(e),r=0;if(1297377380!==t.getUint32(0))throw Error("Invalid MIDI file");let a=t.getUint32(4),i=t.getUint16(8),s=t.getUint16(10),l=t.getUint16(12);r=8+a;let n=[];for(let h=0;h<s;h++){if(1297379947!==t.getUint32(r))throw Error("Invalid track header");let o=t.getUint32(r+4),$=r+8+o;r+=8;let f=[],u=0,d=0;for(;r<$;){let c=this.readVariableLength(t,r);r=c.nextOffset,u+=c.value;let x=this.parseEvent(t,r,d);x.absoluteTime=u,f.push(x),r=x.nextOffset,"meta"!==x.type&&"sysex"!==x.type&&(d=x.status)}n.push(f)}return{format:i,trackCount:s,ticksPerBeat:l,tracks:n}}readVariableLength(e,t){let r=0,a;do r=r<<7|127&(a=e.getUint8(t++));while(128&a);return{value:r,nextOffset:t}}parseEvent(e,t,r){let a=e.getUint8(t),i=!1;if(a<128){if(!r)throw Error("Running status expected but none set");a=r,i=!0}let s=a>>4;if(t+=i?0:1,255===a){let l=e.getUint8(t++),n=this.readVariableLength(e,t);t=n.nextOffset;let h=new Uint8Array(e.buffer,t,n.value);return t+=n.value,{type:"meta",metaType:l,data:h,text:1===l||6===l?this.TIS620ToString(h):void 0,absoluteTime:0,nextOffset:t}}if(s>=8&&s<=14){let o={type:"channel",status:a,absoluteTime:0,nextOffset:t},$=12===s||13===s?1:2;o.data=[];for(let f=0;f<$;f++)o.data.push(e.getUint8(t++));return o.nextOffset=t,o}if(240!==a&&247!==a)return{type:"unknown",status:a,absoluteTime:0,nextOffset:t+1};{let u=this.readVariableLength(e,t);t=u.nextOffset;let d=new Uint8Array(e.buffer,t,u.value);return{type:"sysex",data:d,absoluteTime:0,nextOffset:t+=u.value}}}parseFile(e){return this.rawMidiBuffer=e,this.midiData=this.parseMidiFile(e),this.extractAllData(),{midiData:this.midiData,info:this.songInfo,lyrics:this.lyricsData,chords:this.chordsData,detectedHeader:this.detectedHeader}}extractAllData(){this.songInfo={},this.lyricsData=[],this.chordsData=[],this.detectedHeader="LyrHdr1";try{let e=new Uint8Array(this.rawMidiBuffer),t="";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);let a=t.match(/\xff\x01.*?(K?LyrHdr\d*)(.*?)\x00/is);if(a&&a[2]){this.detectedHeader=a[1];let i=a[2],s=this.parseKLyrDataFromEncodedPayload(i);s&&(this.songInfo=s.info,this.lyricsData=s.lyrics)}}catch(l){console.error("Error during regex search:",l)}this.midiData.tracks.forEach(e=>{e.forEach(e=>{"meta"===e.type&&6===e.metaType&&e.text&&this.chordsData.push({chord:e.text,tick:e.absoluteTime})})}),this.chordsData.sort((e,t)=>e.tick-t.tick)}parseKLyrDataFromEncodedPayload(e){try{let t=this.base64ToArrayBuffer(e),r=pako.inflate(t),a=this.TIS620ToString(r),i=new DOMParser,s=i.parseFromString(a,"text/xml");return this.parseKLyrXML(s)}catch(l){return console.error("Error parsing KLyr data from payload:",l),null}}parseKLyrXML(e){let t={},r=e.querySelector("INFO");if(r)for(let a of r.children)t[a.tagName]=a.textContent||"";let i=[],s=e.querySelectorAll("LYRIC LINE");return s.forEach(e=>{let t=[],r=e.querySelectorAll("WORD");r.forEach(e=>{let r=e.querySelector("TIME"),a=e.querySelector("TEXT"),i=e.querySelector("VOCAL");r&&a&&t.push({tick:parseInt(r.textContent||"0"),text:a.textContent||"",vocal:i&&i.textContent||""})}),t.length>0&&i.push(t)}),{info:t,lyrics:i}}buildModifiedMidi(e,t,r,a){let i=this.midiData.format,s=this.midiData.ticksPerBeat,l=this.midiData.tracks.map(e=>e.filter(e=>!("meta"===e.type&&6===e.metaType))),n=[];l.forEach(e=>{let t=e.some(e=>"meta"===e.type&&3===e.metaType&&e.text&&"@LYRIC"===e.text.trim()||"meta"===e.type&&1===e.metaType&&e.text&&e.text.match(/K?LyrHdr\d*/i));t||n.push(e)});let h=r&&r.length>0;if(h){let o=-1,$=-1;for(let f=0;f<n.length;f++){let u=n[f].map(e=>"meta"===e.type&&81===e.metaType).lastIndexOf(!0);if(-1!==u){o=f,$=u;break}}if(-1===o&&n.length>0&&(o=0,$=0),-1!==o){let d=r.map(e=>({type:"meta",metaType:6,text:e.chord.trim(),absoluteTime:e.tick})),c=n[o];c.splice($+1,0,...d),c.sort((e,t)=>e.absoluteTime-t.absoluteTime)}}let x=[...n],p=e&&Object.keys(e).length>0,m=t&&t.length>0;if(p||m){let y=[];y.push({type:"meta",metaType:3,text:"@LYRIC",absoluteTime:0});let g=this.buildKLyrXML(e,t),T=this.encodeKLyrPayload(g);y.push({type:"meta",metaType:1,text:a+T,absoluteTime:1}),x.push(y)}return{format:i,ticksPerBeat:s,tracks:x}}buildKLyrXML(e,t){let r='<?xml version="1.0" encoding="UTF-8"?>\n<SONG_LYRIC>\n',a=e&&Object.keys(e).length>0;if(a){for(let[i,s]of(r+="<INFO>\n",Object.entries(e)))r+=`<${i}>${this.escapeXml(String(s))}</${i}>
`;r+="</INFO>\n"}let l=t&&t.length>0;return l&&(r+="<LYRIC>\n",t.forEach(e=>{e.length>0&&(r+="<LINE>\n",r+=`<TIME>${e[0].tick}</TIME>
`,e.forEach(e=>{r+="<WORD>\n",r+=`<TIME>${e.tick}</TIME>
`,r+=`<TEXT>${this.escapeXml(e.text||e.name||"")}</TEXT>
`,e.vocal&&e.vocal.trim()?r+=`<VOCAL>${this.escapeXml(e.vocal)}</VOCAL>
`:r+=`<VOCAL></VOCAL>
`,r+="</WORD>\n"}),r+="</LINE>\n")}),r+="</LYRIC>\n"),r+="</SONG_LYRIC>"}escapeXml(e){return String(e).replace(/[<>&'"]/g,function(e){switch(e){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case'"':return"&quot;"}})}encodeKLyrPayload(e){let t=this.stringToTIS620(e),r=pako.deflate(t,{level:9});return this.arrayBufferToBase64(r)}buildMidiFile(e,t,r){let a=14,i=[];e.forEach(e=>{let t=this.buildTrackData(e);i.push(t),a+=t.length+8});let s=new ArrayBuffer(a),l=new DataView(s),n=0;return l.setUint32(n,1297377380),l.setUint32(n+4,6),l.setUint16(n+8,t),l.setUint16(n+10,e.length),l.setUint16(n+12,r),n+=14,i.forEach(e=>{l.setUint32(n,1297379947),l.setUint32(n+4,e.length),n+=8;let t=new Uint8Array(s,n,e.length);t.set(new Uint8Array(e)),n+=e.length}),s}buildTrackData(e){let t=[],r=0,a=null,i=[...e].sort((e,t)=>e.absoluteTime-t.absoluteTime);i.forEach(e=>{let i=Math.max(0,e.absoluteTime-r);if(t.push(...this.writeVariableLength(i)),r=e.absoluteTime,"meta"===e.type){t.push(255),t.push(e.metaType);let s;s=void 0!==e.text?this.stringToTIS620(e.text):e.data?e.data:new Uint8Array(0),t.push(...this.writeVariableLength(s.length)),t.push(...s),a=null}else"channel"===e.type?(e.status!==a&&(t.push(e.status),a=e.status),e.data&&t.push(...e.data)):"sysex"===e.type&&(t.push(240),t.push(...this.writeVariableLength(e.data.length)),t.push(...e.data),a=null)});let s=i.some(e=>"meta"===e.type&&47===e.metaType);return!s&&i.length>0?t.push(...this.writeVariableLength(0),255,47,0):0===i.length&&t.push(0,255,47,0),new Uint8Array(t)}writeVariableLength(e){let t=[],r=127&e;for(;e>>=7;)r<<=8,r|=127&e|128;for(;;)if(t.push(255&r),128&r)r>>=8;else break;return t}saveMidi(e,t,r){let a=this.buildModifiedMidi(e,t,r,this.detectedHeader);return this.buildMidiFile(a.tracks,a.format,a.ticksPerBeat)}}export const parseMidiFile=e=>{let t=new MidiKLyrParser;return t.parseFile(e)};export const saveMidiFile=(e,t,r,a)=>{if(!(e instanceof MidiKLyrParser))throw Error("Invalid parser instance");return e.saveMidi(t,r,a)};export default MidiKLyrParser;